// currently bundling various js functions here, need to move to webpack or similar


//==== navmenu behavior ================================================================

$(document).ready(function() {
  attachNavmenuEvents();
  attachTableofContentsEvents();
});

function attachNavmenuEvents() {
  // $('#top-navmenu').toggle(); //debugging toggle
  $('#bottom-navmenu').hide();
  $('#banner .navmenu-button').click((e) => {
    e.preventDefault();
    $('#top-navmenu').toggle();
  });
  $('#page-footer .navmenu-button').click((e) => {
    e.preventDefault();
    $('#bottom-navmenu').toggle();
    $('html, body').scrollTop($('#bottom-navmenu').offset().top);
  });
  $('.navmenu .close').click(e => {
    e.preventDefault();
    $(e.target).closest(".navmenu").parent().toggle();
  });
}

//==== mobile ToC widget ==============================================================

// Event listeners for Table of Contents
function attachTableofContentsEvents() {
  var bodyElement = createBody();
  var dropdownLinks = createDropdownLinks();
  var deviceView = createDeviceView(dropdownLinks, bodyElement);
  deviceView.init();
}

var createDeviceView = function(dropdownLinks, bodyElement) {
  function init() {
    attachStartingEvents();
    attachClosingEvents();
  }

  function attachStartingEvents() {
    dropdownLinks.hide();
    attachToggleDropdownLinksListener();
  }

  function attachToggleDropdownLinksListener() {
    $('.dropdown-button').click((e) => {
      e.preventDefault();
      dropdownLinks.toggle();
      coordinateBodyScroll();
    });
  }

  function coordinateBodyScroll() {
    if (dropdownLinks.areVisible()) {
      bodyElement.disableScroll();
    } else {
      bodyElement.enableScroll();
    }
  }

  function clickOutOfDropdownContentListener() {
    $(document).click((e) => {
      if(!$(e.target).closest('#toc-dropdown').length) {
        if (dropdownLinks.areVisible()) {
          dropdownLinks.hide();
          bodyElement.enableScroll();
        }
      }
    });
  };

  function clickFromLinksDropdownContentListener() {
    $('#dropdownLinks').children().click((e) => {
      dropdownLinks.hide();
      if (!dropdownLinks.areVisible()) {
        bodyElement.enableScroll();
      }
    });
  };

  function attachClosingEvents() {
    clickOutOfDropdownContentListener();
    clickFromLinksDropdownContentListener();
  }

  return {
    init: init
  }
}

var createBody = function() {
  var bodyElement = function() {
    return $('body');
  }
  function disableBodyScroll() {
    bodyElement().toggleClass('no-scroll', true);
  }
  function enableBodyScroll() {
    bodyElement().toggleClass('no-scroll', false);
  }

  return {
    disableScroll: disableBodyScroll,
    enableScroll: enableBodyScroll
  }

}

var createDropdownLinks = function() {
    var dropdownLinks = function () {
      return $('#dropdownLinks');
    };

  function container() {
    return $('#toc-dropdown');
  }


    var dropdownLinksAreVisible = function () {
      return dropdownLinks().is(":visible");
    };

    function hide() {
      container().removeClass('show-dropdown-links');
    }

    function toggle() {
      container().toggleClass('show-dropdown-links');
    }

    return {
      hide: hide,
      toggle: toggle,
      areVisible: dropdownLinksAreVisible
    }
};


//==== support for article cards ================================================================

function isSmallScreen() {
  return window.innerWidth < 600
}


function encloseWhenSmall(mainSelector, summarySelector) {
  if (isSmallScreen())
    document.querySelectorAll(mainSelector).forEach( card => {
      const detailsElement = document.createElement('details');
      card.appendChild(detailsElement);
      const summaryElement = document.createElement('summary');
      detailsElement.appendChild(summaryElement);
      const summary = card.querySelector(summarySelector);
      summaryElement.appendChild(summary);
      detailsElement.appendChild(card.querySelector('.card-body'));
      summary.textContent = summaryElement.querySelector('a').textContent;
    });
}
